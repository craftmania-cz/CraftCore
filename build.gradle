buildscript {
    repositories {
        mavenCentral()
        maven { url = "https://oss.sonatype.org/content/repositories/snapshots/" }
        jcenter()
    }
    dependencies {
        classpath 'com.github.jengelman.gradle.plugins:shadow:1.2.3'
        classpath 'org.ajoberstar:grgit:1.7.0'
        classpath 'com.netflix.nebula:gradle-aggregate-javadocs-plugin:2.2.+'
    }
}

apply plugin: 'java'
apply plugin: 'nebula-aggregate-javadocs'
apply plugin: 'signing'

clean { delete './target' }
clean { delete './build' }

apply plugin: 'maven'

group = 'cz.craftmania.craftcore'

description = """"""

sourceCompatibility = 1.8
targetCompatibility = 1.8

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

task setupCIWorkspace {
    // do nothing, stub method
}

def mainVersion = "2.3.0"
def branch = ""
def gitId = ""

ext {
    try {
        git = org.ajoberstar.grgit.Grgit.open(file(".git"))
        date = git.head().date.format("yy.MM.dd")
        //gitId = "-${git.head().abbreviatedId}"
        gitId = "-SNAPSHOT"
    } catch (Throwable ignore) {
        gitId = "-unknown"
    }
    try {
        git = org.ajoberstar.grgit.Grgit.open(file(".git"))
        date = git.head().date.format("yy.MM.dd")
        if (ciBranch.isEmpty() || ciBranch.equalsIgnoreCase("master") || ciBranch.equalsIgnoreCase("head")) {
            branch = "-${git.branch.current.fullName}".replace("refs/heads/", "")
            if (branch.toString().equalsIgnoreCase("-master") || branch.toString().equalsIgnoreCase("-head")) {
                branch = ""
                gitId = ""
            }
        } else {
            branch = "-" + ciBranch
        }
    } catch (Throwable ignore) {
        branch = "-unknown"
    }
} 

// Name-master-76735d.jar
allprojects {
    version = mainVersion + branch + gitId
}

artifacts {
    archives file("./target/craftcore-" + version + ".jar")
    //archives file("./target/craftcore-bungee-" + version + "-sources.jar")
    //archives file("./target/craftcore-main-" + version + "-sources.jar")
    //archives file("./target/craftcore-spigot-" + version + "-sources.jar")
}

subprojects {

    apply plugin: 'java'
    apply plugin: 'maven'
    apply plugin: 'eclipse'
    apply plugin: 'idea'
    apply plugin: 'signing'

    sourceCompatibility = 1.8
    targetCompatibility = 1.8

    compileJava {
        options.compilerArgs += ["-parameters"]
    }

    task sourcesJar(type: Jar, dependsOn: classes) {
        classifier = 'sources'
        archiveName = "${parent.name}-${project.name}-${parent.version}-sources.jar"
        from sourceSets.main.allSource
        destinationDir = file '../target'
    }

    artifacts {
        archives sourcesJar
    }
    build.dependsOn(sourcesJar)
}

uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: "${nexusUrl}/repository/release") {
                authentication(userName: nexusUsername, password: nexusPassword)
            }
            snapshotRepository(url: "${nexusUrl}/repository/snapshots") {
                authentication(userName: nexusUsername, password: nexusPassword)
            }
        }
    }
}
